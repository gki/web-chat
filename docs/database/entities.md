# エンティティ関連図

## 実現すべきポイント

### データモデルの基本要求
- **シンプル性**: チャットアプリで必要最小限のエンティティ構成
- **可扩張性**: 将来機能拡張を見据えた柔軟な設計
- **パフォーマンス**: 効率的なクエリ実行とインデックス戦略
- **整合性**: 参照整合性とビジネスルールの適切な実装

### リレーショナルモデルの採用
- **結合度**: UserとMessageの明確な1:N関係定義
- **正規化**: ユーザー情報とメッセージ情報の適切な分離
- **一貫性**: ACIDトランザクションによるデータ一貫性保証
- **可読性**: シンプルなテーブル構成での理解容易性

## 選択の背景・理由

### CUID識別子採用の理由

#### ユニーク識別子戦略
- **分散対応**: 将来的な水平スケーリング時の衝突回避
- **推測困難性**: 連続数値と異なりセキュリティ向上
- **可読性**: UUIDより短く、デバッグ時の視認性向上
- **パフォーマンス**: インデックスサイズと検索性能のバランス

#### ユーザー名制約の設計意図
- **柔軟性**: 同名許可による登録障壁の低減
- **将来対応**: ユニーク制約は必要時に後から追加可能
- **ユーザビリティ**: 複雑なユーザー名ルールの回避
- **シンプル性**: MVP段階での実装コスト最小化

### カスケード削除戦略の意図
- **データ整合性**: 孤立メッセージの発生防止
- **ユーザビリティ**: ユーザー削除時の適切なデータクリーンアップ
- **シンプル性**: 手動でのメッセージ削除作業の不要
- **コンプライアンス**: プライバシー法対応時のデータ削除容易性

### 段階的パフォーマンス最適化計画
- **Phase 1**: 基本インデックスの導入とパフォーマンス測定
- **Phase 2**: ユーザー数増加時の追加インデックス最適化
- **Phase 3**: パーティショニング戦略とアーカイブ戦略
- **Phase 4**: NoSQLや分散データベースへの移行検討

## 検討した代替案と却下理由

### データベース設計代替案

#### NoSQLアプローチ（MongoDB等）
- **長所**: スキーマ柔軟性、水平スケーリング、JSONデータ自然表現
- **短所**: ACIDトランザクション制限、結合検索的限定、学習コスト
- **却下理由**: チャットのリレーショナルデータ構造、ACID要求

#### UUID v4識別子
- **長所**: 完全ランダム、標準仕様、分散対応完全
- **短所**: 文字列長、インデックスサイズ、可読性低下
- **却下理由**: CUIDの簡潔性と可読性優位性

#### 自動連番・Auto Increment
- **長所**: サイズ効率、高速検索、シンプル性
- **短所**: 分散環境不対応、推測可能性、セキュリティリスク
- **却下理由**: 将来的なスケーリング要求、セキュリティ考慮

### リレーション設計代替案

#### 非正規化アプローチ
- **長所**: クエリシンプル化、パフォーマンス向上、JOIN不要
- **短所**: データ重複、更新異常、ストレージ容量増加
- **却下理由**: データ整合性要求、ユーザー情報変更頻度

#### 単一テーブル設計
- **長所**: 最大限のシンプル性、クエリ高速化、管理容易
- **短所**: データ重複、スケーラビリティ制限、将来拡張困難
- **却下理由**: 機能拡張性、メンテナンス性、データ整合性

## 将来への影響・考慮事項

### スキーマ進化計画

#### 機能拡張に伴うエンティティ追加
- **Roomエンティティ**: マルチルームチャット対応
- **Attachmentエンティティ**: ファイル・画像添付機能
- **Reactionエンティティ**: メッセージリアクション機能
- **Notificationエンティティ**: 通知システム統合

#### 既存エンティティの拡張
- **Userエンティティ**: プロフィール情報、パーミッション、オンライン状態
- **Messageエンティティ**: 編集履歴、返信関係、ピン留め機能
- **インデックス拡張**: 全文検索、複合インデックス、パーティション

### データベース移行戦略

#### PostgreSQL移行計画
- **移行タイミング**: 同時接続数が100人を超えた時点
- **データ移行**: ゼロダウンタイムでの段階的データ移行
- **アプリケーション対応**: Prisma ORMのデータベース抽象化活用
- **パフォーマンス検証**: 移行前後の性能測定と最適化

#### マイクロサービス対応
- **データベース分離**: ユーザーサービス・メッセージサービスの独立化
- **イベントソーシング**: メッセージ履歴のイベント駆動アーキテクチャ
- **CQRSパターン**: 読み取り・書き込みモデルの分離
- **データ一貫性**: 結果的一貫性とイベントラル一貫性の選択

### パフォーマンス最適化

#### スケーラビリティ対応
- **読み取りレプリカ**: 読み取り負荷分散とレイテンシ最適化
- **シャーディング**: 水平分割による書き込み性能向上
- **キャッシュ戦略**: Redis統合とアプリケーションレベルキャッシュ
- **アーカイブ戦略**: 古いメッセージの段階的アーカイブとコールドストレージ

#### メンテナンス性向上
- **マイグレーション管理**: スキーマ変更のバージョン管理と安全な実行
- **モニタリング**: データベースパフォーマンスメトリクスの継続監視
- **バックアップ戦略**: ポイントインタイムリカバリと点夥22おける完全性
- **データガバナンス**: プライバシー法対応とデータライフサイクル管理